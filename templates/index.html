<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VK Link Rewriter</title>
  <style>
    :root {
      --bg: #0f0f12;
      --card: #16161b;
      --input: #1c1c23;
      --border: #2a2a34;
      --blue: #2787f5;
      --blue-dim: rgba(39, 135, 245, 0.15);
      --text: #e4e4e7;
      --muted: #a1a1aa;
      --error: #ef4444;
      --radius: 12px;
      --radius-sm: 8px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      padding: 2rem;
    }
    .wrap { max-width: 700px; margin: 0 auto; }
    h1 { font-size: 1.5rem; margin: 0 0 0.25rem 0; }
    .sub { color: var(--muted); font-size: 0.9rem; margin: 0 0 1.5rem 0; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem 1.5rem;
      margin-bottom: 1rem;
    }
    .field { margin-bottom: 1rem; }
    .field label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.35rem; }
    input, textarea {
      width: 100%;
      background: var(--input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.6rem 0.75rem;
      color: var(--text);
      font-size: 0.95rem;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px var(--blue-dim);
    }
    textarea { resize: vertical; min-height: 100px; font-family: inherit; }
    input[type="file"] {
      padding: 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .file-hint { font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem; }
    .err {
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error);
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-sm);
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .btns { display: flex; gap: 0.75rem; margin-top: 0.5rem; }
    button {
      padding: 0.6rem 1.25rem;
      border-radius: var(--radius-sm);
      font-weight: 500;
      font-size: 0.95rem;
      cursor: pointer;
      border: none;
      font-family: inherit;
    }
    .btn-run {
      background: var(--blue);
      color: #fff;
    }
    .btn-run:hover:not(:disabled) { filter: brightness(1.1); }
    .btn-run:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-stop {
      background: var(--input);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-stop:hover:not(:disabled) { background: var(--border); }
    .btn-stop:disabled { opacity: 0.5; cursor: not-allowed; }
    .log-title { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem; }
    .log {
      background: #0a0a0c;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 1rem;
      min-height: 200px;
      max-height: 400px;
      overflow: auto;
      font-family: ui-monospace, monospace;
      font-size: 0.8rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log-empty { color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>VK Link Rewriter</h1>
    <p class="sub">Массовая замена ссылок в постах и комментариях сообществ ВКонтакте</p>

    <div class="card">
      <form id="form">
        <div class="field">
          <label for="token">VK токен *</label>
          <input id="token" name="token" type="password" placeholder="Токен с правами wall, groups, offline" autocomplete="off">
        </div>
        <div class="field">
          <label for="old">Старая ссылка (что искать)</label>
          <input id="old" name="old_link" type="text" placeholder="https://...">
        </div>
        <div class="field">
          <label for="new">Новая ссылка (на что заменить)</label>
          <input id="new" name="new_link" type="text" placeholder="https://...">
        </div>
        <div class="field">
          <label for="communities">Ссылки или ID сообществ (по одной в строке)</label>
          <textarea id="communities" name="communities" placeholder="https://vk.com/public123&#10;https://vk.com/club123"></textarea>
          <div class="file-hint">Или загрузите .txt файл — по одной ссылке или ID в строке</div>
          <input type="file" id="fileCommunities" accept=".txt,text/plain" style="margin-top: 0.5rem;">
        </div>
        <div id="err" class="err" style="display:none;"></div>
        <div class="btns">
          <button type="submit" class="btn-run" id="btnRun">Запустить</button>
          <button type="button" class="btn-stop" id="btnStop" disabled>Остановить</button>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="log-title">Лог</div>
      <div id="log" class="log log-empty">Лог появится после запуска…</div>
    </div>
  </div>

  <script>
    const form = document.getElementById('form');
    const errEl = document.getElementById('err');
    const logEl = document.getElementById('log');
    const btnRun = document.getElementById('btnRun');
    const btnStop = document.getElementById('btnStop');
    const tokenInput = document.getElementById('token');
    const fileCommunitiesInput = document.getElementById('fileCommunities');
    let aborter = null;

    const TOKEN_KEY = 'vk_rewriter_token';
    const TOKEN_TTL_MS = 10 * 24 * 60 * 60 * 1000; // 10 дней

    function loadToken() {
      try {
        const raw = localStorage.getItem(TOKEN_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.value && data.lastUsed && (Date.now() - data.lastUsed < TOKEN_TTL_MS))
          tokenInput.value = data.value;
        else if (data.lastUsed && (Date.now() - data.lastUsed >= TOKEN_TTL_MS))
          localStorage.removeItem(TOKEN_KEY);
      } catch (_) {}
    }
    function saveToken(token) {
      if (!token) return;
      try {
        localStorage.setItem(TOKEN_KEY, JSON.stringify({ value: token, lastUsed: Date.now() }));
      } catch (_) {}
    }
    loadToken();

    function showErr(msg) {
      errEl.textContent = msg || '';
      errEl.style.display = msg ? 'block' : 'none';
    }

    function appendLog(text) {
      if (!text) return;
      if (logEl.classList.contains('log-empty')) {
        logEl.classList.remove('log-empty');
        logEl.textContent = '';
      }
      logEl.textContent += text;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function parseCommunitiesText(text) {
      return (text || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result || '');
        r.onerror = () => reject(new Error('Не удалось прочитать файл'));
        r.readAsText(file, 'UTF-8');
      });
    }

    fileCommunitiesInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      readFileAsText(file).then(text => {
        document.getElementById('communities').value = text;
      }).catch(() => {});
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = tokenInput.value.trim();
      const oldLink = document.getElementById('old').value.trim();
      const newLink = document.getElementById('new').value.trim();
      let communities = parseCommunitiesText(document.getElementById('communities').value);

      if (communities.length === 0 && fileCommunitiesInput.files && fileCommunitiesInput.files[0]) {
        try {
          const text = await readFileAsText(fileCommunitiesInput.files[0]);
          communities = parseCommunitiesText(text);
          if (communities.length) document.getElementById('communities').value = text;
        } catch (_) {}
      }

      if (!token) { showErr('Укажите VK токен.'); return; }
      if (!oldLink || !newLink) { showErr('Укажите старую и новую ссылки.'); return; }
      if (!communities.length) { showErr('Укажите хотя бы одно сообщество или загрузите .txt файл.'); return; }

      saveToken(token);

      showErr('');
      logEl.classList.remove('log-empty');
      logEl.textContent = 'Запуск…\n\n';
      btnRun.disabled = true;
      btnStop.disabled = false;
      aborter = new AbortController();

      try {
        const res = await fetch('/api/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, old_link: oldLink, new_link: newLink, communities }),
          signal: aborter.signal
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Ошибка ' + res.status);
        }

        const reader = res.body.getReader();
        const dec = new TextDecoder();
        let buf = '';
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buf += dec.decode(value, { stream: true });
          const parts = buf.split('\n\n');
          buf = parts.pop() || '';
          for (const part of parts) {
            const lines = part.split('\n').filter(s => s.startsWith('data: ')).map(s => s.slice(6));
            if (lines.length) appendLog(lines.join('\n') + '\n');
          }
        }
        if (buf) {
          const lines = buf.split('\n').filter(s => s.startsWith('data: ')).map(s => s.slice(6));
          if (lines.length) appendLog(lines.join('\n') + '\n');
        }
      } catch (e) {
        if (e.name === 'AbortError') appendLog('\nОстановлено.\n');
        else {
          showErr(e.message || 'Ошибка запроса');
          appendLog('\n' + (e.message || 'Ошибка') + '\n');
        }
      } finally {
        btnRun.disabled = false;
        btnStop.disabled = true;
        aborter = null;
      }
    });

    btnStop.addEventListener('click', () => {
      if (aborter) aborter.abort();
      fetch('/api/stop', { method: 'POST' }).catch(() => {});
    });
  </script>
</body>
</html>
